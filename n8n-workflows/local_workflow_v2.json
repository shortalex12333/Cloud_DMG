{
  "name": "Signature_Installer_Local_v2_FIXED",
  "nodes": [
    {
      "parameters": {},
      "id": "trigger-start",
      "name": "Start Registration",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [-800, 300]
    },
    {
      "parameters": {
        "functionCode": "/*\n * CelesteOS Yacht Registration - Consolidated Local Installer\n * \n * This node handles the complete yacht registration process:\n * 1. Read yacht config from filesystem\n * 2. Register with cloud API\n * 3. Poll for activation (up to 30 minutes)\n * 4. Save credentials locally\n */\n\nconst fs = require('fs');\nconst path = require('path');\nconst https = require('https');\nconst http = require('http');\n\n// Configuration\nconst MAX_POLL_ATTEMPTS = 60;\nconst POLL_INTERVAL_MS = 30000; // 30 seconds\nconst CONFIG_PATHS = [\n  '/etc/celeste/config.json',\n  '/data/celeste/config.json',\n  process.env.CELESTE_CONFIG_PATH,\n  path.join(process.env.HOME || '/root', '.celeste', 'config.json')\n].filter(Boolean);\n\n// Helper: Sleep function\nconst sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));\n\n// Helper: Make HTTP request\nconst makeRequest = (url, options = {}) => {\n  return new Promise((resolve, reject) => {\n    const urlObj = new URL(url);\n    const protocol = urlObj.protocol === 'https:' ? https : http;\n    \n    const requestOptions = {\n      hostname: urlObj.hostname,\n      port: urlObj.port || (urlObj.protocol === 'https:' ? 443 : 80),\n      path: urlObj.pathname + urlObj.search,\n      method: options.method || 'GET',\n      headers: options.headers || {}\n    };\n\n    const req = protocol.request(requestOptions, (res) => {\n      let data = '';\n      res.on('data', (chunk) => data += chunk);\n      res.on('end', () => {\n        try {\n          const parsed = JSON.parse(data);\n          resolve({ statusCode: res.statusCode, body: parsed, headers: res.headers });\n        } catch (e) {\n          resolve({ statusCode: res.statusCode, body: data, headers: res.headers });\n        }\n      });\n    });\n\n    req.on('error', (error) => reject(error));\n    \n    if (options.body) {\n      req.write(typeof options.body === 'string' ? options.body : JSON.stringify(options.body));\n    }\n    \n    req.end();\n  });\n};\n\n// Step 1: Read yacht config\nconst readConfig = () => {\n  for (const configPath of CONFIG_PATHS) {\n    try {\n      if (fs.existsSync(configPath)) {\n        const content = fs.readFileSync(configPath, 'utf8');\n        const config = JSON.parse(content);\n        \n        if (!config.yacht_id || !config.yacht_id_hash) {\n          throw new Error('Config missing yacht_id or yacht_id_hash');\n        }\n        \n        return {\n          success: true,\n          config: config,\n          config_path: configPath\n        };\n      }\n    } catch (err) {\n      // Continue to next path\n      continue;\n    }\n  }\n  \n  throw new Error(`Config not found. Searched: ${CONFIG_PATHS.join(', ')}`);\n};\n\n// Step 2: Register yacht with cloud\nconst registerYacht = async (config) => {\n  const apiEndpoint = config.api_endpoint || 'https://api.celeste7.ai';\n  const url = `${apiEndpoint}/register`;\n  \n  try {\n    const response = await makeRequest(url, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: {\n        yacht_id: config.yacht_id,\n        yacht_id_hash: config.yacht_id_hash\n      }\n    });\n    \n    if (response.statusCode !== 200) {\n      return {\n        success: false,\n        error: 'registration_failed',\n        status_code: response.statusCode,\n        message: response.body.message || 'Registration failed',\n        details: response.body\n      };\n    }\n    \n    return {\n      success: true,\n      response: response.body\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: 'network_error',\n      message: error.message\n    };\n  }\n};\n\n// Step 3: Poll for activation\nconst pollActivation = async (config) => {\n  const apiEndpoint = config.api_endpoint || 'https://api.celeste7.ai';\n  const url = `${apiEndpoint}/check-activation/${config.yacht_id}`;\n  \n  for (let attempt = 1; attempt <= MAX_POLL_ATTEMPTS; attempt++) {\n    try {\n      const response = await makeRequest(url, {\n        method: 'GET'\n      });\n      \n      if (response.statusCode !== 200) {\n        // Non-200 response, but continue polling\n        await sleep(POLL_INTERVAL_MS);\n        continue;\n      }\n      \n      const body = response.body;\n      \n      // Check status\n      if (body.status === 'active' && body.shared_secret) {\n        // Success! Yacht is activated and we have credentials\n        return {\n          success: true,\n          credentials: {\n            yacht_id: body.yacht_id,\n            yacht_id_hash: body.yacht_id_hash,\n            shared_secret: body.shared_secret,\n            activated_at: body.activated_at\n          },\n          attempts: attempt\n        };\n      } else if (body.status === 'already_retrieved') {\n        // Credentials already fetched\n        return {\n          success: false,\n          error: 'credentials_already_retrieved',\n          message: 'Credentials have already been retrieved for this yacht',\n          attempts: attempt\n        };\n      } else if (body.status === 'invalid') {\n        // Invalid yacht ID\n        return {\n          success: false,\n          error: 'invalid_yacht_id',\n          message: body.message || 'Invalid yacht ID',\n          attempts: attempt\n        };\n      } else if (body.status === 'pending') {\n        // Still waiting for activation\n        // Sleep and continue polling\n        await sleep(POLL_INTERVAL_MS);\n        continue;\n      }\n      \n      // Unknown status\n      await sleep(POLL_INTERVAL_MS);\n    } catch (error) {\n      // Network error, continue polling\n      await sleep(POLL_INTERVAL_MS);\n      continue;\n    }\n  }\n  \n  // Timeout\n  return {\n    success: false,\n    error: 'timeout',\n    message: `Activation not completed within ${(MAX_POLL_ATTEMPTS * POLL_INTERVAL_MS) / 1000 / 60} minutes`,\n    attempts: MAX_POLL_ATTEMPTS\n  };\n};\n\n// Step 4: Save credentials\nconst saveCredentials = (credentials) => {\n  const dataDir = process.env.DATA_DIR || '/data';\n  const credPath = path.join(dataDir, 'yacht_credentials.json');\n  \n  try {\n    // Ensure directory exists\n    if (!fs.existsSync(dataDir)) {\n      fs.mkdirSync(dataDir, { recursive: true, mode: 0o700 });\n    }\n    \n    // Add retrieval timestamp\n    const credData = {\n      ...credentials,\n      retrieved_at: new Date().toISOString()\n    };\n    \n    // Write credentials\n    fs.writeFileSync(credPath, JSON.stringify(credData, null, 2), { mode: 0o600 });\n    \n    // Verify\n    const stats = fs.statSync(credPath);\n    const fileMode = (stats.mode & parseInt('777', 8)).toString(8);\n    \n    return {\n      success: true,\n      credentials_path: credPath,\n      file_mode: fileMode,\n      yacht_id: credentials.yacht_id\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: 'save_failed',\n      message: error.message,\n      attempted_path: credPath\n    };\n  }\n};\n\n// Main execution flow\nconst main = async () => {\n  const result = {\n    timestamp: new Date().toISOString(),\n    steps: []\n  };\n  \n  try {\n    // Step 1: Read config\n    result.steps.push({ step: 'read_config', status: 'started' });\n    const configResult = readConfig();\n    result.config = configResult;\n    result.steps[result.steps.length - 1].status = 'completed';\n    result.steps[result.steps.length - 1].config_path = configResult.config_path;\n    \n    const config = configResult.config;\n    result.yacht_id = config.yacht_id;\n    \n    // Step 2: Register\n    result.steps.push({ step: 'register', status: 'started' });\n    const registerResult = await registerYacht(config);\n    result.registration = registerResult;\n    \n    if (!registerResult.success) {\n      result.steps[result.steps.length - 1].status = 'failed';\n      result.success = false;\n      result.error = registerResult.error;\n      result.message = registerResult.message;\n      return result;\n    }\n    \n    result.steps[result.steps.length - 1].status = 'completed';\n    \n    // Step 3: Poll for activation\n    result.steps.push({ step: 'poll_activation', status: 'started' });\n    const pollResult = await pollActivation(config);\n    result.activation = pollResult;\n    \n    if (!pollResult.success) {\n      result.steps[result.steps.length - 1].status = 'failed';\n      result.success = false;\n      result.error = pollResult.error;\n      result.message = pollResult.message;\n      result.poll_attempts = pollResult.attempts;\n      return result;\n    }\n    \n    result.steps[result.steps.length - 1].status = 'completed';\n    result.steps[result.steps.length - 1].poll_attempts = pollResult.attempts;\n    \n    // Step 4: Save credentials\n    result.steps.push({ step: 'save_credentials', status: 'started' });\n    const saveResult = saveCredentials(pollResult.credentials);\n    result.save = saveResult;\n    \n    if (!saveResult.success) {\n      result.steps[result.steps.length - 1].status = 'failed';\n      result.success = false;\n      result.error = saveResult.error;\n      result.message = saveResult.message;\n      return result;\n    }\n    \n    result.steps[result.steps.length - 1].status = 'completed';\n    result.steps[result.steps.length - 1].credentials_path = saveResult.credentials_path;\n    \n    // Success!\n    result.success = true;\n    result.message = `Yacht ${config.yacht_id} successfully registered and activated`;\n    result.credentials_path = saveResult.credentials_path;\n    \n    return result;\n    \n  } catch (error) {\n    result.success = false;\n    result.error = 'unexpected_error';\n    result.message = error.message;\n    result.stack = error.stack;\n    return result;\n  }\n};\n\n// Execute and return result\nconst output = await main();\nreturn [{ json: output }];"
      },
      "id": "yacht-registration-main",
      "name": "Yacht Registration (All-in-One)",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [-400, 300],
      "notes": "Complete yacht registration process in a single node.\nHandles:\n- Config reading\n- Registration API call\n- Polling for activation (30 min max)\n- Credential storage\n\nNo external dependencies except Manual Trigger."
    }
  ],
  "connections": {
    "Start Registration": {
      "main": [[{ "node": "Yacht Registration (All-in-One)", "type": "main", "index": 0 }]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "v2-fixed-consolidated",
  "meta": {
    "instanceId": "celeste7-local-v2-fixed"
  },
  "id": "local_v2_fixed_consolidated",
  "tags": ["yacht", "identity", "v2", "fixed", "local", "consolidated"]
}
